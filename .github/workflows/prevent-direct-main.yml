name: prevent-direct-main

on:
  push:
    branches:
      - main

jobs:
  guard-main:
    name: Block direct pushes to main
    runs-on: ubuntu-latest
    steps:
      - name: Check commit source
        run: |
          msg="$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH")"

          if [ -z "$msg" ]; then
            echo "Unable to read commit message from event payload (missing head_commit.message). Verify push payload structure and workflow read permissions."
            exit 1
          fi

          is_merge_commit=false
          if printf '%s' "$msg" | grep -qiE '^Merge pull request #[0-9]+'; then
            is_merge_commit=true
          elif printf '%s' "$msg" | grep -qiE '^Merge branch '; then
            is_merge_commit=true
          elif printf '%s' "$msg" | grep -qiE '^.+ \(#[0-9]+\)$'; then
            is_merge_commit=true
          fi

          if [ "$is_merge_commit" = true ]; then
            echo "Merge-based commit detected; allowed."
            exit 0
          fi

          echo "Direct pushes to main are not allowed. Please open a pull request."
          exit 1
