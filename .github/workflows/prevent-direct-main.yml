name: prevent-direct-main

on:
  push:
    branches:
      - main

jobs:
  guard-main:
    name: Block direct pushes to main
    runs-on: ubuntu-latest
    steps:
      - name: Check commit source
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not available on runner."
            exit 1
          fi

          msg="$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH")"

          if [ -z "$msg" ]; then
            echo "Unable to read commit message; failing to protect main."
            exit 1
          fi

          if printf '%s' "$msg" | grep -qiE '^(Merge (pull request|branch))|(#([0-9]+))$'; then
            echo "Merge-based commit detected; allowed."
            exit 0
          fi

          if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
            echo "Dependabot push allowed."
            exit 0
          fi

          echo "Direct pushes to main are not allowed. Please open a pull request."
          exit 1
